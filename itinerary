<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åå¤å±‹ãƒ»å†¬æ—¥ç§æ—…æ‰‹æœ­</title>
    
    <!-- å¼•å…¥å­—é«”èˆ‡åœ–æ¨™ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#f0fdfa',
                            100: '#ccfbf1',
                            500: '#14b8a6', // Teal
                            600: '#0d9488',
                            700: '#0f766e',
                        },
                        stone: {
                            50: '#fafaf9',
                            100: '#f5f5f4',
                            800: '#292524',
                        },
                        accent: {
                            lime: '#84cc16',
                            pink: '#f472b6'
                        }
                    },
                    fontFamily: {
                        sans: ['"Inter"', '"Noto Sans TC"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* å…¨å±€æ¨£å¼å¾®èª¿ */
        body {
            background-color: #f7f9f6; /* æ¥µæ·ºçš„ç°ç¶ è‰² */
            color: #44403c; /* Stone 700 */
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 80px; /* ç•™çµ¦åº•éƒ¨å°èˆª */
        }
        
        /* éš±è—æ»¾å‹•æ¢ä½†ä¿ç•™åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* å¡ç‰‡ç»ç’ƒæ“¬æ…‹èˆ‡é™°å½± */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }

        /* åº•éƒ¨å°èˆªæŒ‰éˆ•å‹•ç•« */
        .nav-btn.active {
            color: #0d9488;
        }
        .nav-btn.active i {
            transform: translateY(-2px);
        }
        .nav-btn.active span {
            font-weight: 500;
        }

        /* è‡ªå®šç¾© Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #0d9488;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #0d9488;
        }
        
        /* é é¢åˆ‡æ›å‹•ç•« */
        .page-section {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        .page-section.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* AI Chat Styles */
        .chat-bubble {
            max-width: 80%;
            padding: 10px 14px;
            border-radius: 16px;
            margin-bottom: 10px;
            font-size: 0.9rem;
            line-height: 1.5;
            position: relative;
            word-wrap: break-word;
        }
        .chat-bubble.user {
            background-color: #0d9488; /* Brand 600 */
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .chat-bubble.ai {
            background-color: #ffffff;
            color: #44403c;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border: 1px solid #f0fdfa;
        }
        .ai-fab {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #14b8a6, #0f766e);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(13, 148, 136, 0.4);
            z-index: 50;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        .ai-fab:active {
            transform: scale(0.95);
        }
        .ai-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #f7f9f6;
            z-index: 60;
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .ai-modal.open {
            transform: translateY(0);
        }
        /* Markdown style tweaks for AI response */
        .chat-bubble.ai strong { font-weight: 600; color: #0f766e; }
        .chat-bubble.ai ul { margin-left: 1.2em; list-style-type: disc; }
        .chat-bubble.ai ol { margin-left: 1.2em; list-style-type: decimal; }
        
        /* Typing indicator */
        .typing-dot {
            width: 6px;
            height: 6px;
            background: #ccc;
            border-radius: 50%;
            display: inline-block;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body>

    <!-- é ‚éƒ¨ Header -->
    <header class="fixed top-0 left-0 right-0 z-40 bg-white/90 backdrop-blur-md border-b border-stone-100 px-6 py-4 shadow-sm transition-all duration-300" id="main-header">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold text-brand-700 tracking-wide">Nagoya Trip</h1>
                <p class="text-xs text-stone-400 font-light tracking-widest">2026.01.02 - 01.09</p>
            </div>
            <div class="w-10 h-10 bg-brand-50 rounded-full flex items-center justify-center text-brand-600 shadow-inner cursor-pointer" onclick="toggleAI()">
                <i class="fa-solid fa-robot"></i>
            </div>
        </div>
    </header>

    <!-- ä½”ä½ç¬¦ï¼Œé˜²æ­¢å…§å®¹è¢« Fixed Header é®æ“‹ -->
    <div class="h-20"></div>

    <!-- ==================== PAGE 1: PLAN (è¡Œç¨‹è¡¨) ==================== -->
    <section id="page-plan" class="page-section active px-4">
        <!-- èˆªç­èˆ‡ä½å®¿æ‘˜è¦å¡ç‰‡ -->
        <div class="glass-card rounded-2xl p-5 mb-6 border-l-4 border-brand-500">
            <h3 class="text-sm font-bold text-stone-400 uppercase mb-3 tracking-wider">Flight & Stay</h3>
            <div class="flex justify-between items-center mb-2">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-plane-departure text-brand-500"></i>
                    <span class="font-medium">HKG <i class="fa-solid fa-arrow-right text-xs text-stone-300 mx-1"></i> NGO</span>
                </div>
                <span class="text-sm bg-brand-50 text-brand-700 px-2 py-0.5 rounded">UO680</span>
            </div>
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-plane-arrival text-brand-500"></i>
                    <span class="font-medium">NGO <i class="fa-solid fa-arrow-right text-xs text-stone-300 mx-1"></i> HKG</span>
                </div>
                <span class="text-sm bg-brand-50 text-brand-700 px-2 py-0.5 rounded">UO681</span>
            </div>
            <div class="border-t border-stone-100 pt-3 flex items-start gap-3">
                <i class="fa-solid fa-hotel text-accent-lime mt-1"></i>
                <div>
                    <p class="font-bold text-stone-700">Nagoya JR Gate Tower Hotel</p>
                    <a href="https://www.google.com/maps/search/?api=1&query=Nagoya+JR+Gate+Tower+Hotel" target="_blank" class="text-xs text-stone-400 underline mt-1 block">æŸ¥çœ‹åœ°åœ–</a>
                </div>
            </div>
        </div>

        <!-- æ¯æ—¥è¡Œç¨‹åˆ—è¡¨å®¹å™¨ -->
        <div id="itinerary-list" class="space-y-6">
            <!-- JS å°‡è‡ªå‹•æ¸²æŸ“è¡Œç¨‹ -->
        </div>
    </section>

    <!-- ==================== PAGE 2: GUIDE (æ·±åº¦å°è¦½) ==================== -->
    <section id="page-guide" class="page-section px-4">
        <h2 class="text-2xl font-bold text-stone-700 mb-6 pl-2 border-l-4 border-accent-lime">æ·±åº¦å°è¦½ Guide</h2>
        
        <!-- ç™½å·é„‰ -->
        <div class="glass-card rounded-2xl overflow-hidden mb-8">
            <div class="h-48 bg-stone-200 relative">
                <img src="https://images.unsplash.com/photo-1548266652-99cf27701ced?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80" alt="Shirakawa-go" class="w-full h-full object-cover">
                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-4">
                    <h3 class="text-white font-bold text-lg">ç™½å·é„‰åˆæŒæ‘</h3>
                </div>
            </div>
            <div class="p-6">
                <p class="text-stone-600 text-sm leading-relaxed mb-4 text-justify">
                    1995å¹´è¢«ç™»éŒ„ç‚ºä¸–ç•Œæ–‡åŒ–éºç”¢ã€‚é€™è£¡çš„å»ºç¯‰ç¨±ç‚ºã€ŒåˆæŒé€ ã€ï¼Œå±‹é ‚å‘ˆ60åº¦æ€¥æ–œé¢ï¼Œç‹€ä¼¼é›™æ‰‹åˆåï¼Œæ˜¯ç‚ºäº†é˜²æ­¢åšé‡çš„ç©é›ªå£“å®æˆ¿å±‹ã€‚æ‘è½ä¸­ä»æœ‰å±…æ°‘ç”Ÿæ´»ï¼Œæ˜¯ã€Œæ´»è‘—çš„éºç”¢ã€ã€‚å†¬å­£é»ç‡ˆæ™‚ï¼Œå®›å¦‚ç«¥è©±ä¸–ç•Œã€‚
                </p>
                <div class="bg-stone-50 p-3 rounded-lg text-xs text-stone-500 mb-4">
                    <i class="fa-solid fa-lightbulb text-yellow-500 mr-1"></i> <span class="font-bold">å†·çŸ¥è­˜ï¼š</span>å±‹é ‚çš„èŒ…è‰æ¯30-40å¹´éœ€æ›´æ›ä¸€æ¬¡ï¼Œå…¨æ‘äººæœƒåˆåŠ›å®Œæˆï¼Œç¨±ç‚ºã€Œçµ(Yui)ã€ã€‚
                </div>
                <!-- OpenStreetMap iframe for Shirakawa-go -->
                <div class="w-full h-48 rounded-lg overflow-hidden border border-stone-200">
                    <iframe width="100%" height="100%" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" src="https://www.openstreetmap.org/export/embed.html?bbox=136.8950%2C36.2500%2C136.9150%2C36.2650&amp;layer=mapnik&amp;marker=36.2560%2C136.9050"></iframe>
                </div>
            </div>
        </div>

        <!-- ä¼Šå‹¢ç¥å®® -->
        <div class="glass-card rounded-2xl overflow-hidden mb-8">
            <div class="h-48 bg-stone-200 relative">
                <img src="https://images.unsplash.com/photo-1572973802388-c89b3a04293f?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80" alt="Ise Jingu" class="w-full h-full object-cover">
                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-4">
                    <h3 class="text-white font-bold text-lg">ä¼Šå‹¢ç¥å®® (å¿ƒéˆæ•…é„‰)</h3>
                </div>
            </div>
            <div class="p-6">
                <p class="text-stone-600 text-sm leading-relaxed mb-4 text-justify">
                    æ—¥æœ¬äººä¸€ç”Ÿå¿…å»ä¸€æ¬¡çš„å¿ƒéˆæ•…é„‰ã€‚åˆ†ç‚ºä¾›å¥‰è±å—å¤§å¾¡ç¥çš„ã€Œå¤–å®®ã€èˆ‡ä¾›å¥‰å¤©ç…§å¤§å¾¡ç¥çš„ã€Œå…§å®®ã€ã€‚åƒæ‹œé †åºå‚³çµ±ä¸Šç‚ºã€Œå…ˆå¤–å®®ï¼Œå¾Œå…§å®®ã€ã€‚
                </p>
                <div class="bg-stone-50 p-3 rounded-lg text-xs text-stone-500 mb-4">
                    <i class="fa-solid fa-triangle-exclamation text-brand-500 mr-1"></i> <span class="font-bold">æ³¨æ„ï¼š</span>æ­£å®®åªèƒ½åœ¨å¤–ç‰†åƒæ‹œï¼Œä¸”å…§éƒ¨çµ•å°ç¦æ­¢æ”å½±ã€‚
                </div>
            </div>
        </div>
    </section>

    <!-- ==================== PAGE 3: WALLET (è¨˜å¸³èˆ‡åŒ¯ç‡) ==================== -->
    <section id="page-wallet" class="page-section px-4">
        <!-- åŒ¯ç‡è¨ˆç®—æ©Ÿ -->
        <div class="glass-card rounded-2xl p-6 mb-6 bg-gradient-to-br from-white to-brand-50">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-stone-700">åŒ¯ç‡è¨ˆç®—æ©Ÿ</h3>
                <div class="flex items-center gap-2 text-xs">
                    <span>åŒ¯ç‡:</span>
                    <input type="number" id="exchange-rate" value="0.22" step="0.001" class="w-16 bg-white border border-stone-200 rounded px-2 py-1 text-center font-mono">
                </div>
            </div>
            
            <div class="relative mb-4">
                <input type="text" id="calc-input" placeholder="è¼¸å…¥ç®—å¼ (å¦‚ 500+200*3)" class="w-full text-2xl font-mono p-3 rounded-xl border border-stone-200 focus:outline-none focus:border-brand-500 bg-white/80 text-right text-stone-800 placeholder:text-sm placeholder:text-stone-300">
                <span class="absolute left-3 top-4 text-stone-400 text-sm">JPY</span>
            </div>
            
            <div class="flex justify-between items-center mb-4">
                <button onclick="calculate()" class="bg-brand-600 text-white px-6 py-2 rounded-lg shadow-md hover:bg-brand-700 active:scale-95 transition-all text-sm font-bold w-full mr-3">
                    <i class="fa-solid fa-calculator mr-2"></i>è¨ˆç®—
                </button>
                <div class="text-right">
                    <div class="text-xs text-stone-400">ç´„åˆ HKD</div>
                    <div id="calc-result" class="text-xl font-bold text-brand-600">0.00</div>
                </div>
            </div>
        </div>

        <!-- è¨˜å¸³è¼¸å…¥å€ -->
        <div class="glass-card rounded-2xl p-6 mb-6">
            <h3 class="font-bold text-stone-700 mb-4">æ–°å¢æ”¯å‡º</h3>
            <div class="grid grid-cols-3 gap-3 mb-3">
                <input type="text" id="expense-item" placeholder="å“é …" class="col-span-2 p-2 border border-stone-200 rounded-lg text-sm bg-stone-50 focus:bg-white transition-colors">
                <input type="number" id="expense-amt" placeholder="æ—¥å¹£" class="col-span-1 p-2 border border-stone-200 rounded-lg text-sm bg-stone-50 focus:bg-white transition-colors">
            </div>
            
            <!-- æ‹ç…§æŒ‰éˆ• (å£“ç¸®è™•ç†) -->
            <div class="flex gap-3 mb-4">
                <label for="expense-photo" class="flex-1 cursor-pointer bg-stone-100 text-stone-500 rounded-lg border border-dashed border-stone-300 flex items-center justify-center py-2 hover:bg-stone-200 transition-colors text-sm">
                    <i class="fa-solid fa-camera mr-2"></i><span id="photo-label">æ‹ç…§/ä¸Šå‚³</span>
                </label>
                <input type="file" id="expense-photo" accept="image/*" class="hidden" onchange="handleImageUpload(this)">
                
                <button onclick="addExpense()" class="flex-1 bg-stone-800 text-white rounded-lg font-bold py-2 shadow hover:bg-stone-900 transition-colors text-sm">
                    è¨˜å¸³
                </button>
            </div>
            <div id="preview-container" class="hidden mb-2">
                <img id="image-preview" class="h-20 rounded object-cover border border-stone-200">
            </div>
        </div>

        <!-- è¨˜å¸³åˆ—è¡¨ -->
        <div class="mb-4 flex justify-between items-end">
            <h3 class="font-bold text-stone-700">æ”¯å‡ºç´€éŒ„</h3>
            <div class="text-xs text-stone-500">
                ç¸½è¨ˆ: <span id="total-jpy" class="font-mono font-bold text-stone-800">0</span> JPY
            </div>
        </div>
        
        <div id="expense-list" class="space-y-3 pb-8">
            <!-- JS æ¸²æŸ“åˆ—è¡¨ -->
        </div>
        
        <div class="text-center mt-4">
            <button onclick="clearExpenses()" class="text-xs text-red-400 underline p-2">æ¸…ç©ºæ‰€æœ‰ç´€éŒ„</button>
        </div>
    </section>

    <!-- ==================== PAGE 4: LISTS (æ¸…å–®) ==================== -->
    <section id="page-lists" class="page-section px-4">
        
        <!-- è¡Œå‰æª¢æŸ¥ -->
        <div class="glass-card rounded-2xl p-5 mb-6">
            <h3 class="font-bold text-stone-700 mb-4 flex items-center">
                <i class="fa-solid fa-suitcase-rolling text-accent-lime mr-2"></i> è¡Œå‰æº–å‚™
            </h3>
            <div id="checklist-container" class="space-y-2">
                <!-- JS æ¸²æŸ“ -->
            </div>
            <div class="mt-3 flex gap-2">
                <input type="text" id="new-check-item" placeholder="æ–°å¢é …ç›®..." class="flex-1 border-b border-stone-200 bg-transparent text-sm py-1 focus:outline-none focus:border-brand-500">
                <button onclick="addCheckItem()" class="text-brand-600 text-sm font-bold">+</button>
            </div>
        </div>

        <!-- å‚™å¿˜éŒ„ -->
        <div class="glass-card rounded-2xl p-5">
            <h3 class="font-bold text-stone-700 mb-4 flex items-center">
                <i class="fa-solid fa-pen-nib text-brand-500 mr-2"></i> å‚™å¿˜éŒ„ (Memo)
            </h3>
            <textarea id="memo-area" class="w-full h-40 bg-brand-50/50 rounded-xl p-4 text-sm text-stone-600 leading-relaxed border-none focus:ring-2 focus:ring-brand-200 resize-none" placeholder="è¼¸å…¥ç­†è¨˜æˆ–ç¶²å€..."></textarea>
            <div id="memo-links" class="mt-3 flex flex-wrap gap-2">
                <!-- è‡ªå‹•è§£æçš„é€£çµæŒ‰éˆ• -->
            </div>
        </div>
    </section>

    <!-- ==================== PAGE 5: INFO (è³‡è¨Š) ==================== -->
    <section id="page-info" class="page-section px-4">
        <h2 class="text-2xl font-bold text-stone-700 mb-6 pl-2 border-l-4 border-stone-400">å¯¦ç”¨è³‡è¨Š Info</h2>

        <div class="grid grid-cols-2 gap-4 mb-6">
            <a href="https://www.jma.go.jp/bosai/forecast/" target="_blank" class="glass-card p-4 rounded-2xl flex flex-col items-center justify-center gap-2 hover:bg-stone-50 transition-colors">
                <i class="fa-solid fa-cloud-sun text-3xl text-sky-400"></i>
                <span class="text-sm font-bold text-stone-600">å¤©æ°£é å ±</span>
            </a>
            <a href="https://www.google.com/maps" target="_blank" class="glass-card p-4 rounded-2xl flex flex-col items-center justify-center gap-2 hover:bg-stone-50 transition-colors">
                <i class="fa-solid fa-map-location-dot text-3xl text-brand-500"></i>
                <span class="text-sm font-bold text-stone-600">Google Maps</span>
            </a>
        </div>

        <div class="glass-card rounded-2xl p-5 mb-6 border border-red-100">
            <h3 class="font-bold text-red-500 mb-3"><i class="fa-solid fa-phone-volume mr-2"></i>ç·Šæ€¥è¯çµ¡</h3>
            <ul class="space-y-3 text-sm text-stone-600">
                <li class="flex justify-between border-b border-stone-100 pb-2">
                    <span>è­¦å¯Ÿå±€</span>
                    <a href="tel:110" class="font-mono font-bold text-stone-800">110</a>
                </li>
                <li class="flex justify-between border-b border-stone-100 pb-2">
                    <span>æ•‘è­·è»Š/ç«è­¦</span>
                    <a href="tel:119" class="font-mono font-bold text-stone-800">119</a>
                </li>
                <li class="flex justify-between">
                    <span>å°åŒ—é§æ—¥ç¶“æ¿Ÿæ–‡åŒ–ä»£è¡¨è™•</span>
                    <a href="tel:+81-3-3280-7811" class="font-mono font-bold text-stone-800">03-3280-7811</a>
                </li>
            </ul>
        </div>

        <div class="glass-card rounded-2xl p-5">
            <h3 class="font-bold text-stone-700 mb-3"><i class="fa-solid fa-circle-exclamation mr-2 text-yellow-500"></i>æº«é¦¨æé†’</h3>
            <ul class="list-disc list-outside ml-4 space-y-2 text-sm text-stone-500">
                <li>æ—¥æœ¬é›»å£“ç‚º100Vï¼Œæ’åº§ç‚ºé›™å¹³è…³ï¼ˆèˆ‡å°ç£ç›¸åŒï¼‰ï¼Œé€šå¸¸ä¸éœ€è¦è½‰æ¥é ­ã€‚</li>
                <li>å…¥å¢ƒç¦æ­¢æ”œå¸¶è‚‰é¡è£½å“ï¼ˆå«è‚‰ä¹¾ã€é¦™è…¸ï¼‰ã€‚</li>
                <li>è³¼ç‰©æ»¿ 5,500 æ—¥åœ“å¯æ†‘è­·ç…§é€€ç¨… (Tax Free)ã€‚</li>
                <li>æ­ä¹˜æ‰‹æ‰¶æ¢¯åœ¨åå¤å±‹é€šå¸¸æ˜¯ã€Œç«™å·¦é‚Šã€ï¼ˆèˆ‡é—œæ±ç›¸åŒï¼Œé—œè¥¿ç«™å³é‚Šï¼‰ï¼Œä½†è§€å¯Ÿå‰é¢çš„äººæœ€æº–ã€‚</li>
            </ul>
        </div>
    </section>

    <!-- ==================== AI FAB & MODAL ==================== -->
    <div class="ai-fab" onclick="toggleAI()">
        <i class="fa-solid fa-robot text-2xl"></i>
    </div>

    <div id="ai-modal" class="ai-modal">
        <!-- AI Header -->
        <div class="bg-brand-600 text-white p-4 flex justify-between items-center shadow-md">
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-sparkles text-yellow-300"></i>
                <h3 class="font-bold text-lg">AI éš¨èº«å°éŠ</h3>
            </div>
            <button onclick="toggleAI()" class="text-white hover:text-brand-100 transition-colors">
                <i class="fa-solid fa-chevron-down text-xl"></i>
            </button>
        </div>

        <!-- API Key Settings (Collapsed by default) -->
        <div id="api-key-container" class="bg-brand-50 px-4 py-2 border-b border-brand-100 text-xs flex justify-between items-center">
            <span class="text-brand-700">API Key è¨­å®š</span>
            <input type="password" id="user-api-key" placeholder="è¼¸å…¥æ‚¨çš„ Gemini API Key" class="border border-brand-200 rounded px-2 py-1 w-40 text-stone-700" onchange="saveApiKey(this.value)">
        </div>

        <!-- Chat Area -->
        <div id="chat-container" class="flex-1 overflow-y-auto p-4 bg-stone-50 no-scrollbar">
            <div class="chat-bubble ai">
                å—¨ï¼æˆ‘æ˜¯æ‚¨çš„åå¤å±‹æ—…éŠ AI åŠ©æ‰‹ ğŸ‘‹ã€‚<br>
                æˆ‘å·²ç¶“è®€å–äº†æ‚¨çš„è¡Œç¨‹ï¼Œæ‚¨å¯ä»¥å•æˆ‘é—œæ–¼æ™¯é»çš„æ­·å²ã€äº¤é€šå»ºè­°ï¼Œæˆ–æ˜¯è«‹æˆ‘å¹«å¿™ç¿»è­¯æ—¥æ–‡å–”ï¼<br>
                <span class="text-xs text-stone-400 mt-2 block">ğŸ’¡ è©¦è©¦çœ‹ï¼šã€Œæ˜å¤©çš„åˆé¤æ¨è–¦åƒä»€éº¼ï¼Ÿã€æˆ–ã€Œè«‹å¹«æˆ‘ç¿»è­¯ã€æˆ‘ä¸åƒè¾£ã€ã€</span>
            </div>
        </div>

        <!-- Input Area -->
        <div class="p-4 bg-white border-t border-stone-200 flex gap-2 items-end">
            <textarea id="chat-input" rows="1" class="flex-1 bg-stone-100 border border-stone-200 rounded-2xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500 resize-none" placeholder="è¼¸å…¥å•é¡Œ..."></textarea>
            <button onclick="sendMessage()" class="bg-brand-600 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg hover:bg-brand-700 transition-colors mb-1">
                <i class="fa-solid fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <!-- åº•éƒ¨å°èˆªåˆ— -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-stone-200 px-6 py-2 pb-5 z-50 flex justify-between items-center shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
        <button onclick="switchTab('plan')" class="nav-btn active flex flex-col items-center text-stone-400 transition-all duration-300" data-target="plan">
            <i class="fa-solid fa-calendar-days text-xl mb-1"></i>
            <span class="text-[10px]">è¡Œç¨‹</span>
        </button>
        <button onclick="switchTab('guide')" class="nav-btn flex flex-col items-center text-stone-400 transition-all duration-300" data-target="guide">
            <i class="fa-solid fa-book-open text-xl mb-1"></i>
            <span class="text-[10px]">å°è¦½</span>
        </button>
        <button onclick="switchTab('wallet')" class="nav-btn flex flex-col items-center text-stone-400 transition-all duration-300" data-target="wallet">
            <i class="fa-solid fa-wallet text-xl mb-1"></i>
            <span class="text-[10px]">éŒ¢åŒ…</span>
        </button>
        <button onclick="switchTab('lists')" class="nav-btn flex flex-col items-center text-stone-400 transition-all duration-300" data-target="lists">
            <i class="fa-solid fa-list-check text-xl mb-1"></i>
            <span class="text-[10px]">æ¸…å–®</span>
        </button>
        <button onclick="switchTab('info')" class="nav-btn flex flex-col items-center text-stone-400 transition-all duration-300" data-target="info">
            <i class="fa-solid fa-circle-info text-xl mb-1"></i>
            <span class="text-[10px]">è³‡è¨Š</span>
        </button>
    </nav>

    <script>
        // ================= DATA =================
        const tripData = [
            {
                day: 1, date: "1/2 (äº”)", title: "æŠµé”åå¤å±‹ - è¼•é¬†é©æ‡‰",
                highlight: false,
                content: [
                    { type: "time", text: "æŠµé”ä¸­éƒ¨åœ‹éš›æ©Ÿå ´ -> å¸‚å€ Check-in", icon: "fa-plane-arrival" },
                    { type: "food", text: "æ™šé¤ï¼šä¸–ç•Œçš„å±±å°‡ (æ‰‹ç¾½å…ˆ) æˆ– çŸ¢å ´ç”ºå‘³å™Œè±¬æ’", link: "https://www.google.com/maps/search/Sekai+no+Yamachan+Nagoya" },
                    { type: "stay", text: "ä½å®¿ï¼šåå¤å±‹ JR Gate Tower Hotel", icon: "fa-bed" },
                    { type: "tip", text: "ç¬¬ä¸€å¤©åˆ¥æ’å¤ªæ»¿ï¼Œè®“é•·è¼©é©æ‡‰å®¤å…§å¤–æº«å·®ã€‚", icon: "fa-heart" }
                ]
            },
            {
                day: 2, date: "1/3 (å…­)", title: "åå¤å±‹å¸‚å…§æ‚ é–’éŠ",
                highlight: false,
                content: [
                    { type: "spot", text: "ä¸Šåˆï¼šç†±ç”°ç¥å®® (æ–°å¹´åƒæ‹œ)", link: "https://goo.gl/maps/example" },
                    { type: "spot", text: "ä¸‹åˆï¼šå¤§é ˆè§€éŸ³å•†åº—è¡— æˆ– å¾·å·åœ’", link: "" },
                    { type: "food", text: "æ™šé¤ï¼šè“¬èŠè»’ é°»é­šé£¯ä¸‰åƒ (éœ€é ç´„)", link: "https://www.google.com/maps/search/Atsuta+Horaiken" },
                    { type: "stay", text: "ä½å®¿ï¼šçºŒä½åå¤å±‹", icon: "fa-bed" }
                ]
            },
            {
                day: 3, date: "1/4 (æ—¥)", title: "ç™½å·é„‰åˆæŒæ‘ä¸€æ—¥éŠ",
                highlight: true, // åŒ…è»Š/è·Ÿåœ˜ é‡é»æ¨™ç¤º
                tag: "å·´å£«åœ˜",
                content: [
                    { type: "transport", text: "åƒåŠ åå¤å±‹å‡ºç™¼ä¸€æ—¥å·´å£«åœ˜ (è»Šæ¥è»Šé€)", icon: "fa-bus" },
                    { type: "spot", text: "åƒè§€ã€Œå’Œç”°å®¶ã€æˆ–ã€Œç¥ç”°å®¶ã€", link: "" },
                    { type: "food", text: "åˆé¤ï¼šé£›é©’ç‰›æ–™ç†", link: "" },
                    { type: "tip", text: "åœ°é¢éå¸¸æ»‘ï¼Œèµ°è·¯è¦æ¥µæ…¢ï¼", icon: "fa-snowflake" },
                    { type: "stay", text: "ä½å®¿ï¼šçºŒä½åå¤å±‹ (è¼•è£)", icon: "fa-bed" }
                ]
            },
            {
                day: 4, date: "1/5 (ä¸€)", title: "å‰å¾€ä¼Šå‹¢ç¥å®®",
                highlight: true,
                tag: "è§€å…‰ç‰¹æ€¥",
                content: [
                    { type: "transport", text: "æ­ä¹˜è¿‘éµè§€å…‰ç‰¹æ€¥ Shimakaze å³¶é¢¨è™Ÿ", icon: "fa-train" },
                    { type: "spot", text: "ä¸Šåˆï¼šä¼Šå‹¢ç¥å®®ï¼ˆå¤–å®®ï¼‰", link: "" },
                    { type: "spot", text: "ä¸‹åˆï¼šä¼Šå‹¢ç¥å®®ï¼ˆå…§å®®ï¼‰ -> æ‰˜ç¦æ©«ä¸", link: "" },
                    { type: "food", text: "å¿…åƒï¼šèµ¤ç¦ã€ä¼Šå‹¢çƒé¾éºµ", link: "" },
                    { type: "stay", text: "ä½å®¿ï¼šé³¥ç¾½æº«æ³‰é£¯åº— (å«æ¥é€)", icon: "fa-hot-tub-person" }
                ]
            },
            {
                day: 5, date: "1/6 (äºŒ)", title: "é³¥ç¾½ - æµ·å¥³èˆ‡çç ",
                highlight: false,
                content: [
                    { type: "spot", text: "ä¸Šåˆï¼šé³¥ç¾½æ°´æ—é¤¨ (çœ‹å„’è‰®)", link: "" },
                    { type: "exp", text: "åˆé¤ï¼šæµ·å¥³å°å±‹é«”é©— (ç¾çƒ¤æµ·é®®)", icon: "fa-fire-burner" },
                    { type: "spot", text: "ä¸‹åˆï¼šå¾¡æœ¨æœ¬çç å³¶ (æµ·å¥³è¡¨æ¼”)", link: "" },
                    { type: "stay", text: "ä½å®¿ï¼šçºŒä½é³¥ç¾½ æˆ– æ¾é˜ª", icon: "fa-bed" }
                ]
            },
            {
                day: 6, date: "1/7 (ä¸‰)", title: "æ¾é˜ªé ‚ç´šå’Œç‰› -> å›åå¤å±‹",
                highlight: true,
                tag: "å’Œç‰›é¥—å®´",
                content: [
                    { type: "spot", text: "ä¸Šåˆï¼šæ¾é˜ªåŸè·¡ / å¾¡åŸç•ªå±‹æ•·", link: "" },
                    { type: "food", text: "åˆé¤ï¼šæ¾é˜ªç‰›å£½å–œç‡’ (å’Œç”°é‡‘/ç‰›éŠ€)", link: "https://www.google.com/maps/search/Wadakin+Matsusaka" },
                    { type: "transport", text: "ä¸‹åˆï¼šè¿‘éµè¿”å›åå¤å±‹", icon: "fa-train" },
                    { type: "stay", text: "ä½å®¿ï¼šåå¤å±‹ç«™å‘¨é‚Š", icon: "fa-bed" }
                ]
            },
            {
                day: 7, date: "1/8 (å››)", title: "è³¼ç‰©èˆ‡æ–‡åŒ–",
                highlight: false,
                content: [
                    { type: "spot", text: "ä¸Šåˆï¼šè±ç”°ç”¢æ¥­æŠ€è¡“ç´€å¿µé¤¨ (å¤§æ¨)", link: "" },
                    { type: "shop", text: "ä¸‹åˆï¼šé«˜å³¶å±‹ç™¾è²¨ / AEON Mall", icon: "fa-bag-shopping" },
                    { type: "food", text: "æ™šé¤ï¼šå±±æœ¬å±‹ç¸½æœ¬å®¶ (å‘³å™Œçƒé¾éºµ)", link: "" }
                ]
            },
            {
                day: 8, date: "1/9 (äº”)", title: "æº–å‚™è¿”ç¨‹",
                highlight: false,
                content: [
                    { type: "transport", text: "æ­ä¹˜åéµ u-sky å‰å¾€æ©Ÿå ´", icon: "fa-train" },
                    { type: "spot", text: "åƒè§€æ©Ÿå ´ Flight of Dreams (æ³¢éŸ³787)", link: "" },
                    { type: "home", text: "å¹³å®‰å›å®¶", icon: "fa-house" }
                ]
            }
        ];

        // ================= INIT & RENDER =================
        document.addEventListener('DOMContentLoaded', () => {
            renderItinerary();
            initWallet();
            initLists();
            initAI();
            
            // æ¢å¾©ä¸Šæ¬¡ç€è¦½çš„åˆ†é  (Optional)
            // const lastTab = localStorage.getItem('travelApp_lastTab') || 'plan';
            // switchTab(lastTab);
        });

        // ================= TAB SWITCHING =================
        function switchTab(tabId) {
            // Hide all sections
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
            // Show target section
            document.getElementById(`page-${tabId}`).classList.add('active');
            
            // Update Nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.nav-btn[data-target="${tabId}"]`).classList.add('active');
            
            // Scroll to top
            window.scrollTo(0, 0);
            
            // LocalStorage (Optional)
            // localStorage.setItem('travelApp_lastTab', tabId);
        }

        // ================= MODULE: PLAN =================
        function renderItinerary() {
            const container = document.getElementById('itinerary-list');
            let html = '';

            tripData.forEach(day => {
                const isHighlight = day.highlight ? 'border-l-4 border-accent-lime' : '';
                const tagHtml = day.tag ? `<span class="ml-2 text-xs bg-accent-lime text-white px-2 py-0.5 rounded-full font-bold">${day.tag}</span>` : '';
                
                let detailsHtml = '';
                day.content.forEach(item => {
                    let icon = 'fa-circle-dot';
                    let colorClass = 'text-stone-300';
                    
                    if(item.type === 'food') { icon = 'fa-utensils'; colorClass = 'text-orange-400'; }
                    if(item.type === 'transport') { icon = 'fa-train-subway'; colorClass = 'text-blue-400'; }
                    if(item.type === 'stay') { icon = 'fa-bed'; colorClass = 'text-brand-400'; }
                    if(item.type === 'tip') { icon = 'fa-heart'; colorClass = 'text-accent-pink'; }
                    if(item.type === 'shop') { icon = 'fa-bag-shopping'; colorClass = 'text-purple-400'; }
                    if(item.icon) icon = item.icon; // Override

                    const linkHtml = item.link ? `<a href="${item.link}" target="_blank" class="ml-auto text-xs text-brand-600 border border-brand-200 px-2 py-0.5 rounded hover:bg-brand-50"><i class="fa-solid fa-map-location-dot"></i> åœ°åœ–</a>` : '';

                    detailsHtml += `
                        <div class="flex items-start gap-3 py-2 border-b border-stone-50 last:border-0">
                            <div class="mt-1 w-5 text-center"><i class="fa-solid ${icon} ${colorClass} text-sm"></i></div>
                            <div class="flex-1">
                                <p class="text-sm text-stone-700 ${item.type === 'tip' ? 'text-stone-500 italic bg-stone-50 p-2 rounded' : ''}">${item.text}</p>
                            </div>
                            ${linkHtml}
                        </div>
                    `;
                });

                html += `
                    <div class="glass-card rounded-2xl p-5 ${isHighlight}">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-lg text-brand-700">Day ${day.day} <span class="text-sm font-normal text-stone-400 ml-1">${day.date}</span>${tagHtml}</h3>
                        </div>
                        <h4 class="font-bold text-stone-600 mb-3">${day.title}</h4>
                        <div class="space-y-1">
                            ${detailsHtml}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // ================= MODULE: WALLET =================
        let expenses = JSON.parse(localStorage.getItem('travelApp_expenses')) || [];
        let tempImageBase64 = null;

        function initWallet() {
            renderExpenses();
            // ç›£è½åŒ¯ç‡è®Šå‹•ä¸¦å­˜å„²
            const rateInput = document.getElementById('exchange-rate');
            const savedRate = localStorage.getItem('travelApp_rate');
            if(savedRate) rateInput.value = savedRate;
            
            rateInput.addEventListener('change', (e) => {
                localStorage.setItem('travelApp_rate', e.target.value);
                renderExpenses(); // æ›´æ–°åˆ—è¡¨é¡¯ç¤ºçš„åŒ¯ç‡
            });
        }

        function calculate() {
            const input = document.getElementById('calc-input').value;
            const rate = parseFloat(document.getElementById('exchange-rate').value);
            const resultDisplay = document.getElementById('calc-result');
            
            try {
                // å®‰å…¨æ€§éæ¿¾: åªå…è¨±æ•¸å­—èˆ‡é‹ç®—ç¬¦
                if(/^[0-9+\-*/().\s]*$/.test(input)) {
                    // ä½¿ç”¨ Function constructor æ›¿ä»£ eval ç¨å¾®å®‰å…¨ä¸€é»
                    const totalJpy = new Function('return ' + input)();
                    const totalHkd = (totalJpy * rate).toFixed(2);
                    
                    document.getElementById('calc-input').value = totalJpy; // æ›´æ–°è¼¸å…¥æ¡†ç‚ºçµæœ
                    resultDisplay.innerText = totalHkd;
                    
                    // è‡ªå‹•å¡«å…¥è¨˜å¸³é‡‘é¡
                    document.getElementById('expense-amt').value = totalJpy;
                } else {
                    alert("è«‹è¼¸å…¥æ­£ç¢ºçš„ç®—å¼ (åƒ…é™æ•¸å­—èˆ‡ +, -, *, /)");
                }
            } catch (e) {
                resultDisplay.innerText = "Error";
            }
        }

        // åœ–ç‰‡å£“ç¸®è™•ç†
        function handleImageUpload(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const img = new Image();
                    img.src = e.target.result;
                    
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // ç¸®æ”¾é‚è¼¯ï¼šæœ€å¤§å¯¬åº¦ 300px (ç¸®åœ–ç”¨)
                        const maxWidth = 300;
                        const scale = maxWidth / img.width;
                        const width = maxWidth;
                        const height = img.height * scale;
                        
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // å£“ç¸®ç‚º JPEG 0.7 å“è³ª
                        tempImageBase64 = canvas.toDataURL('image/jpeg', 0.7);
                        
                        // é¡¯ç¤ºé è¦½
                        const preview = document.getElementById('image-preview');
                        preview.src = tempImageBase64;
                        document.getElementById('preview-container').classList.remove('hidden');
                        document.getElementById('photo-label').innerText = "å·²é¸æ“‡";
                    };
                };
                reader.readAsDataURL(file);
            }
        }

        function addExpense() {
            const item = document.getElementById('expense-item').value;
            const amt = parseFloat(document.getElementById('expense-amt').value);
            
            if(!item || isNaN(amt)) {
                alert("è«‹è¼¸å…¥å“é …èˆ‡é‡‘é¡");
                return;
            }

            const newExpense = {
                id: Date.now(),
                item: item,
                amt: amt,
                img: tempImageBase64,
                date: new Date().toLocaleDateString()
            };

            expenses.unshift(newExpense); // åŠ åˆ°æœ€å‰é¢
            localStorage.setItem('travelApp_expenses', JSON.stringify(expenses));
            
            // é‡ç½®è¡¨å–®
            document.getElementById('expense-item').value = '';
            document.getElementById('expense-amt').value = '';
            document.getElementById('calc-input').value = '';
            document.getElementById('expense-photo').value = '';
            document.getElementById('preview-container').classList.add('hidden');
            document.getElementById('photo-label').innerText = "æ‹ç…§/ä¸Šå‚³";
            tempImageBase64 = null;
            
            renderExpenses();
        }

        function renderExpenses() {
            const container = document.getElementById('expense-list');
            const rate = parseFloat(document.getElementById('exchange-rate').value);
            let total = 0;
            let html = '';

            expenses.forEach(ex => {
                total += ex.amt;
                const hkd = (ex.amt * rate).toFixed(1);
                const imgHtml = ex.img ? `<img src="${ex.img}" class="w-10 h-10 rounded object-cover border border-stone-200" onclick="showFullImage('${ex.img}')">` : `<div class="w-10 h-10 rounded bg-stone-100 flex items-center justify-center text-stone-300"><i class="fa-solid fa-receipt"></i></div>`;

                html += `
                    <div class="flex items-center gap-3 bg-white p-3 rounded-xl shadow-sm border border-stone-50">
                        ${imgHtml}
                        <div class="flex-1">
                            <div class="font-bold text-stone-700">${ex.item}</div>
                            <div class="text-xs text-stone-400">${ex.date}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-mono font-bold text-stone-800">Â¥${ex.amt}</div>
                            <div class="text-xs text-brand-600">â‰ˆ $${hkd}</div>
                        </div>
                        <button onclick="deleteExpense(${ex.id})" class="text-stone-300 hover:text-red-400 px-2"><i class="fa-solid fa-trash"></i></button>
                    </div>
                `;
            });

            container.innerHTML = html;
            document.getElementById('total-jpy').innerText = total.toLocaleString();
        }

        function deleteExpense(id) {
            if(confirm("ç¢ºå®šåˆªé™¤æ­¤ç­†ç´€éŒ„ï¼Ÿ")) {
                expenses = expenses.filter(e => e.id !== id);
                localStorage.setItem('travelApp_expenses', JSON.stringify(expenses));
                renderExpenses();
            }
        }
        
        function clearExpenses() {
            if(confirm("ç¢ºå®šæ¸…ç©ºæ‰€æœ‰è¨˜å¸³è³‡æ–™ï¼Ÿ(ç„¡æ³•å¾©åŸ)")) {
                expenses = [];
                localStorage.setItem('travelApp_expenses', JSON.stringify(expenses));
                renderExpenses();
            }
        }

        // ================= MODULE: LISTS =================
        let checkList = JSON.parse(localStorage.getItem('travelApp_checklist')) || [
            {text: "è­·ç…§", checked: false},
            {text: "æ—¥å¹£ç¾é‡‘", checked: false},
            {text: "ç¶²å¡/æ¼«éŠ", checked: false},
            {text: "è¡Œå‹•é›»æº", checked: false},
            {text: "é•·è¼©å¸¸å‚™è—¥", checked: false}
        ];

        function initLists() {
            renderChecklist();
            
            // Memo Init
            const memoArea = document.getElementById('memo-area');
            memoArea.value = localStorage.getItem('travelApp_memo') || '';
            
            memoArea.addEventListener('input', () => {
                localStorage.setItem('travelApp_memo', memoArea.value);
            });
            
            memoArea.addEventListener('blur', parseMemoLinks);
            parseMemoLinks(); // init load
        }

        function renderChecklist() {
            const container = document.getElementById('checklist-container');
            let html = '';
            
            checkList.forEach((item, index) => {
                const checkedClass = item.checked ? 'line-through text-stone-300' : 'text-stone-700';
                html += `
                    <div class="flex items-center gap-3 group">
                        <input type="checkbox" id="check-${index}" class="toggle-checkbox w-5 h-5 rounded border-stone-300 text-brand-600 focus:ring-brand-500" ${item.checked ? 'checked' : ''} onchange="toggleCheck(${index})">
                        <label for="check-${index}" class="flex-1 ${checkedClass} cursor-pointer select-none transition-colors">${item.text}</label>
                        <button onclick="deleteCheck(${index})" class="text-stone-200 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                `;
            });
            container.innerHTML = html;
            localStorage.setItem('travelApp_checklist', JSON.stringify(checkList));
        }

        function addCheckItem() {
            const input = document.getElementById('new-check-item');
            if(input.value.trim()) {
                checkList.push({text: input.value.trim(), checked: false});
                input.value = '';
                renderChecklist();
            }
        }

        function toggleCheck(index) {
            checkList[index].checked = !checkList[index].checked;
            renderChecklist();
        }
        
        function deleteCheck(index) {
            checkList.splice(index, 1);
            renderChecklist();
        }

        function parseMemoLinks() {
            const text = document.getElementById('memo-area').value;
            const container = document.getElementById('memo-links');
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const urls = text.match(urlRegex);
            
            let html = '';
            if(urls) {
                urls.forEach(url => {
                    // ç°¡å–®ç¸®çŸ­é¡¯ç¤º
                    const display = url.length > 20 ? url.substring(0, 20) + '...' : url;
                    html += `<a href="${url}" target="_blank" class="text-xs bg-white border border-brand-200 text-brand-600 px-2 py-1 rounded-full hover:bg-brand-50 flex items-center gap-1 shadow-sm"><i class="fa-solid fa-link"></i> ${display}</a>`;
                });
            }
            container.innerHTML = html;
        }

        // ================= UTILS =================
        function showFullImage(src) {
            // ç°¡å–®çš„å…¨è¢å¹•é è¦½ (å¯ä»¥ä½¿ç”¨ Modalï¼Œé€™è£¡å¾ç°¡)
            const win = window.open();
            win.document.write('<img src="' + src + '" style="max-width:100%; height:auto;">');
        }

        // ================= MODULE: AI GUIDE =================
        const apiKey = ""; // âš ï¸ é‡è¦ï¼šä¸‹è¼‰æª”æ¡ˆå¾Œè«‹åœ¨æ­¤å¡«å…¥æˆ–ä½¿ç”¨ä»‹é¢è¼¸å…¥ API Key
        let chatHistory = [];
        let userApiKey = localStorage.getItem('travelApp_apiKey') || "";

        function initAI() {
            const savedKey = localStorage.getItem('travelApp_apiKey');
            if(savedKey) {
                document.getElementById('user-api-key').value = savedKey;
                userApiKey = savedKey;
            }
            
            // Enter éµç™¼é€
            document.getElementById('chat-input').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        }

        function toggleAI() {
            document.getElementById('ai-modal').classList.toggle('open');
        }

        function saveApiKey(val) {
            userApiKey = val.trim();
            localStorage.setItem('travelApp_apiKey', userApiKey);
        }

        async function sendMessage() {
            const inputEl = document.getElementById('chat-input');
            const msg = inputEl.value.trim();
            if (!msg) return;

            // 1. é¡¯ç¤ºç”¨æˆ¶è¨Šæ¯
            appendChat('user', msg);
            inputEl.value = '';

            // 2. é¡¯ç¤ºç­‰å¾…å‹•ç•«
            const loadingId = appendLoading();

            // 3. æº–å‚™ Context
            const contextPrompt = `
                ä½ æ˜¯ä¸€ä½è²¼å¿ƒçš„åå¤å±‹å®¶åº­æ—…éŠå°éŠã€‚
                ä½ çš„æœå‹™å°è±¡åŒ…å«é•·è¼©ï¼Œæ‰€ä»¥è«‹ç‰¹åˆ¥æ³¨æ„å›ç­”çš„æ˜“è®€æ€§ã€ä¸¦ä¸»å‹•æé†’ä¼‘æ¯ã€å»æ‰€æˆ–ç„¡éšœç¤™è³‡è¨Šã€‚
                
                é€™æ˜¯ç”¨æˆ¶çš„æ—…éŠè¡Œç¨‹ JSON æ•¸æ“šï¼š
                ${JSON.stringify(tripData)}
                
                è«‹æ ¹æ“šä»¥ä¸Šè¡Œç¨‹èˆ‡ç”¨æˆ¶çš„æå•é€²è¡Œå›ç­”ã€‚
                å›ç­”è«‹ä½¿ç”¨ç¹é«”ä¸­æ–‡ã€‚ä¿æŒèªæ°£è¦ªåˆ‡ã€ç°¡æ½”ã€‚
                å¦‚æœç”¨æˆ¶å•ç¿»è­¯ï¼Œè«‹æä¾›æ—¥æ–‡åŸæ–‡èˆ‡ç™¼éŸ³ã€‚
            `;

            try {
                // å„ªå…ˆä½¿ç”¨ç’°å¢ƒè®Šæ•¸çš„ Key (é è¦½ç”¨)ï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨ç”¨æˆ¶è¼¸å…¥çš„ Key
                const finalKey = apiKey || userApiKey;
                
                if(!finalKey) {
                    removeChat(loadingId);
                    appendChat('ai', 'è«‹å…ˆåœ¨ä¸Šæ–¹è¨­å®šæ¬„è¼¸å…¥æ‚¨çš„ Gemini API Key æ‰èƒ½ä½¿ç”¨ AI åŠŸèƒ½å–”ï¼');
                    return;
                }

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${finalKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [
                            { role: "user", parts: [{ text: contextPrompt + "\n\nç”¨æˆ¶å•é¡Œï¼š" + msg }] }
                        ]
                    })
                });

                const data = await response.json();
                removeChat(loadingId);

                if (data.error) {
                    appendChat('ai', 'æŠ±æ­‰ï¼Œç™¼ç”ŸéŒ¯èª¤ï¼š' + data.error.message);
                } else {
                    const aiText = data.candidates[0].content.parts[0].text;
                    appendChat('ai', aiText);
                }
            } catch (e) {
                removeChat(loadingId);
                appendChat('ai', 'ç¶²è·¯é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                console.error(e);
            }
        }

        function appendChat(role, text) {
            const container = document.getElementById('chat-container');
            const div = document.createElement('div');
            div.className = `chat-bubble ${role}`;
            
            // ç°¡å–®çš„ Markdown è™•ç† (Bold, List)
            let formattedText = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');

            div.innerHTML = formattedText;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            return div; // å›å‚³ element ä»¥ä¾¿å¾ŒçºŒæ“ä½œ
        }

        function appendLoading() {
            const container = document.getElementById('chat-container');
            const div = document.createElement('div');
            div.id = 'loading-' + Date.now();
            div.className = 'chat-bubble ai';
            div.innerHTML = '<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>';
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            return div.id;
        }

        function removeChat(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

    </script>
</body>
</html>
