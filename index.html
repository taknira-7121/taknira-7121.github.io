<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶åº­æ—…éŠè¡Œç¨‹è¦åŠƒ Web App</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Font - Inter (clean and modern) */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            /* Soft stone/beige background for a natural, airy feel */
            background-color: #fcfbf9; 
        }
        /* Style for the main itinerary accordion details */
        .itinerary-accordion-content {
            transition: max-height 0.4s ease-out, padding 0.4s ease-out;
            max-height: 0;
            overflow: hidden;
            padding: 0 1rem;
        }
        .itinerary-accordion-content.active {
            max-height: 1000px; /* Large enough value to show all content */
            padding: 1rem;
        }
        /* Style for the Gemini feature accordion details */
        .gemini-accordion-content {
            transition: max-height 0.5s ease-in-out, opacity 0.5s ease-in-out;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            padding: 0 1rem;
        }
        .gemini-accordion-content.active {
            max-height: 2000px; /* Even larger for lists */
            opacity: 1;
            padding: 1.5rem;
        }
        /* Style for the checkbox list items */
        .checked-item {
            text-decoration: line-through;
            color: #a8a29e; /* Muted stone color */
        }
    </style>
</head>
<body class="p-4 md:p-10 bg-stone-50">

    <div class="max-w-4xl mx-auto">
        <!-- HEADER: Soft colors and rounder corners -->
        <header class="mb-10 text-center bg-white/90 p-8 pt-6 rounded-2xl shadow-xl border border-stone-100">
            <h1 class="text-3xl font-extrabold text-teal-700 tracking-wider">
                ğŸ‡¯ğŸ‡µ å†¬æ—¥ç§æ—…ãƒ»å®¶åº­æ¼«éŠï¼šåå¤å±‹ãƒ»ä¸‰é‡ 8æ—¥
            </h1>
            <p class="text-lg text-stone-600 mt-2 font-light">
                æ—…è¡Œæ—¥æœŸï¼š2026/01/02 ~ 01/09 | ä¸»é¡Œï¼šç·©æ­¥æ…¢è¡Œï¼Œé•·è€…å‹å–„
            </p>
            <div id="auth-status" class="mt-4 text-xs text-stone-400">
                <!-- Auth status and User ID will be injected here -->
            </div>
            <button id="save-itinerary-btn" class="mt-4 px-4 py-2 bg-pink-500 text-white font-bold rounded-xl shadow-md hover:bg-pink-600 transition duration-300 transform hover:scale-[1.02] hidden" disabled>
                ğŸ’¾ å„²å­˜è¡Œç¨‹è‡³é›²ç«¯
            </button>
        </header>
        
        <!-- START: Gemini AI Features Section (Gentle, bordered box) -->
        <div id="ai-features" class="mb-10 p-6 bg-white rounded-2xl shadow-lg border border-dashed border-stone-300 space-y-5">
            <h2 class="text-2xl font-bold text-stone-700 border-b border-stone-200 pb-3">
                <span class="text-2xl mr-2">ğŸŒ¿</span> å¯¦ç”¨æ—…é€”åŠ©æ‰‹
            </h2>
            <p class="text-sm text-stone-500">é»æ“Šå¡ç‰‡å±•é–‹åŠ©æ‰‹ï¼Œå–å¾—å³æ™‚è³‡è¨Šã€‚æ‰€æœ‰ç”Ÿæˆå…§å®¹çš†å¯æ”¶åˆï¼Œä¿æŒé é¢æ¸…çˆ½ã€‚</p>

            <!-- 1. Packing List Accordion Button (Muted Green/Lime) -->
            <button id="toggle-packing-list" class="w-full flex items-center justify-between p-4 bg-lime-600/90 text-white font-semibold rounded-xl shadow-md hover:bg-lime-700 transition duration-300 transform hover:shadow-lg">
                <span>ğŸ’ è¡Œææ¸…å–®ç”Ÿæˆå™¨ (å†¬å­£/é•·è€…/8å¤©)</span>
                <svg class="w-5 h-5 transition-transform duration-300 transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div id="packing-list-content" class="gemini-accordion-content bg-stone-50 rounded-xl shadow-inner border border-lime-100">
                <div id="packing-list-loading" class="text-center py-10 hidden">
                    <svg class="animate-spin h-8 w-8 text-lime-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-2 text-lime-600">AI æ­£åœ¨ç‚ºæ‚¨ç”Ÿæˆå†¬å­£å®¶åº­æ—…è¡Œè¡Œææ¸…å–®...</p>
                </div>
                <div id="packing-list-results" class="text-stone-700 space-y-4">
                    <!-- Results will be inserted here -->
                </div>
            </div>

            <!-- 2. Phrases Accordion Button (Soft Pink/Fuchsia) -->
            <button id="toggle-phrases" class="w-full flex items-center justify-between p-4 bg-pink-400/90 text-white font-semibold rounded-xl shadow-md hover:bg-pink-500 transition duration-300 transform hover:shadow-lg">
                <span>ğŸ’¬ æº«æš–é—œæ‡·ï¼šç·Šæ€¥å”åŠ©ç”¨èª (æ—¥èª)</span>
                <svg class="w-5 h-5 transition-transform duration-300 transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div id="phrases-content" class="gemini-accordion-content bg-stone-50 rounded-xl shadow-inner border border-pink-100">
                <div id="phrases-loading" class="text-center py-10 hidden">
                    <svg class="animate-spin h-8 w-8 text-pink-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-2 text-pink-500">AI æ­£åœ¨ç‚ºæ‚¨ç”Ÿæˆç·Šæ€¥æ—¥èªçŸ­èª...</p>
                </div>
                <div id="phrases-results" class="text-stone-700 space-y-3">
                    <!-- Results will be inserted here -->
                </div>
            </div>
        </div>
        <!-- END: Gemini AI Features Section -->

        <!-- MAIN ITINERARY -->
        <div id="itinerary-container" class="space-y-6">
            <!-- Itinerary cards will be injected here by JavaScript -->
            <div id="itinerary-loading" class="text-center py-12 text-teal-600">
                <svg class="animate-spin h-8 w-8 mx-auto mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p>æ­£åœ¨è¼‰å…¥æ‚¨çš„è¡Œç¨‹è³‡æ–™...</p>
            </div>
        </div>

        <footer class="mt-12 text-center text-sm text-stone-400 p-4">
            <p>æ—…è¡Œçš„æ„ç¾©ï¼Œåœ¨æ–¼ç·©æ­¥æ„Ÿå—èˆ‡å®¶äººåŒåœ¨çš„æ¯ä¸€åˆ»æ™‚å…‰ã€‚</p>
        </footer>
    </div>

    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // setLogLevel('Debug'); // Enable for detailed console logging

        // --- Global/App State ---
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        
        // This itinerary will be overwritten by Firestore data if available
        let currentItinerary = [];
        let packingListStatus = []; // New state for checked packing list items

        // Hardcoded Default Itinerary (Used if no data in Firestore)
        const defaultItinerary = [
            {
                day: 1, date: "1/2 (é€±äº”)", base: "åå¤å±‹ (N1)", title: "æŠµé”èˆ‡åˆæ¢ï¼šé †åˆ©å…¥ä½",
                details: [
                    { time: "15:35", activity: "UO680 ç­æ©Ÿ å¾é¦™æ¸¯ (HKG) å‡ºç™¼", transport: "é¦™æ¸¯å¿«é‹", note: "è«‹é å…ˆç¢ºèªè¡Œæé¡åº¦ã€‚" },
                    { time: "20:05", activity: "æŠµé”ä¸­éƒ¨åœ‹éš›æ©Ÿå ´ (NGO)", transport: "æ©Ÿå ´æŠµé”", note: "æ™šé–“å…¥å¢ƒï¼Œç¯€å¥æ”¾æ…¢ã€‚" },
                    { time: "21:00", activity: "NGO â†’ åå¤å±‹å¸‚å€", transport: "åéµ Î¼-SKY ç‰¹æ€¥åˆ—è»Š", note: "è»Šç¨‹ï¼šç´„ 30 åˆ†é˜ã€‚ç¢ºä¿é•·è€…æœ‰æŒ‡å®šåº§ä½ã€‚" },
                    { time: "22:00", activity: "Check-in åå¤å±‹é£¯åº—", transport: "æ­¥è¡Œ/è¨ˆç¨‹è»Š", note: "å»ºè­°é¸æ“‡è¿‘è»Šç«™æˆ–æ¦®åœ°å€ã€‚" },
                    { time: "22:30", activity: "æ™šé¤èˆ‡ä¼‘æ¯", transport: "é£¯åº—å‘¨é‚Š", note: "ä»¥ä¼‘æ¯ç‚ºä¸»ï¼Œæº–å‚™éš”å¤©é•·é€”ç§»å‹•ã€‚" }
                ]
            },
            {
                day: 2, date: "1/3 (é€±å…­)", base: "åå¤å±‹ (N2)", title: "ä¸–ç•Œéºç”¢ï¼šç™½å·é„‰åˆæŒæ‘ä¸€æ—¥éŠ",
                details: [
                    { time: "07:30", activity: "å‡ºç™¼è‡³åéµå·´å£«ä¸­å¿ƒ", transport: "åœ°éµ/æ­¥è¡Œ", note: "ææ—©å‡ºé–€ä»¥æ‡‰å°æ–°å¹´äººæ½®ã€‚" },
                    { time: "07:40", activity: "é«˜é€Ÿå·´å£« (å»ç¨‹)", transport: "åéµ/æ¿ƒé£›å·´å£« (é ç´„åˆ¶)", note: "å–®ç¨‹è»Šç¨‹ï¼šç´„ 2.5ï½3 å°æ™‚ã€‚è«‹å‹™å¿…æå‰é è¨‚è»Šç¥¨ã€‚" },
                    { time: "10:30", activity: "æŠµé”ç™½å·é„‰ï¼Œåƒè§€åˆæŒæ‘", transport: "å·´å£«æŠµé”", note: "å†¬å­£åœ°é¢å¯èƒ½ç©é›ª/çµå†°ï¼Œ**å‹™å¿…ç©¿é˜²æ»‘é‹**ã€‚" },
                    { time: "13:00", activity: "åˆé¤", transport: "èšè½å…§ç”¨é¤", note: "å“åšè•éº¥éºµæˆ–é„‰åœŸæ–™ç†ã€‚" },
                    { time: "14:30", activity: "å±•æœ›å° (å…¨æ™¯)", transport: "æ¥é§å°å·´", note: "æ¬£è³å…¨æ™¯ï¼Œæ³¨æ„ä¿æš–ã€‚" },
                    { time: "16:00", activity: "é›†åˆ/é«˜é€Ÿå·´å£« (å›ç¨‹)", transport: "åéµ/æ¿ƒé£›å·´å£« (é ç´„åˆ¶)", note: "éœ€æå‰é è¨‚å›ç¨‹ç­æ¬¡ã€‚" },
                    { time: "19:00", activity: "æŠµé”åå¤å±‹", transport: "å·´å£«æŠµé”", note: "å›é£¯åº—ä¼‘æ¯ã€‚" },
                    { time: "20:00", activity: "æ™šé¤", transport: "åå¤å±‹å¸‚å€", note: "å¯é¸æ“‡å‘³å™Œè±¬æ’ã€‚" }
                ]
            },
            // ... (Rest of the default itinerary omitted for brevity but should be included)
             {
                day: 3,
                date: "1/4 (é€±æ—¥)",
                base: "ä¼Šå‹¢/é³¥ç¾½ (I1)",
                title: "ç§»å‹•æ—¥ï¼šä¼Šå‹¢ç¥å®®å¤–å®®èˆ‡å…§å®®åƒæ‹œ",
                details: [
                    { time: "09:00", activity: "Check-out åå¤å±‹é£¯åº—", transport: "è™•ç†è¡Œæ", note: "åƒ…æ”œå¸¶è¼•ä¾¿è¡Œæå‰å¾€ä¼Šå‹¢ã€‚" },
                    { time: "10:00", activity: "åå¤å±‹ â†’ ä¼Šå‹¢å¸‚", transport: "è¿‘éµç‰¹æ€¥åˆ—è»Š", note: "è»Šç¨‹ï¼šç´„ 1 å°æ™‚ 35 åˆ†é˜ã€‚**å¿…é è¨‚æŒ‡å®šå¸­**ã€‚" },
                    { time: "11:45", activity: "æŠµé”ä¼Šå‹¢å¸‚ç«™ï¼Œåˆé¤", transport: "è»Šç«™å‘¨é‚Š", note: "" },
                    { time: "14:00", activity: "ä¼Šå‹¢ç¥å®® å¤–å®® (Geku)", transport: "æ­¥è¡Œ (é è¿‘è»Šç«™)", note: "åœ°å‹¢å¹³å¦ï¼Œé©åˆé•·è€…ã€‚" },
                    { time: "15:30", activity: "ä¼Šå‹¢ç¥å®® å…§å®® (Naiku)", transport: "CAN Bus (ä¸‰é‡äº¤é€šå·´å£«)", note: "å…§å®®åƒé“ç‚ºç¢çŸ³è·¯ï¼Œè«‹æº–å‚™è¼ªæ¤…æˆ–æŸ¥å”åŠ©æœå‹™ã€‚" },
                    { time: "17:30", activity: "Check-in ä¼Šå‹¢/é³¥ç¾½é£¯åº—", transport: "CAN Bus æˆ–è¨ˆç¨‹è»Š", note: "ä»Šæ—¥èµ·é€£çºŒå…¥ä½ 3 æ™šã€‚" },
                    { time: "19:30", activity: "æ™šé¤", transport: "é£¯åº—æˆ–ç•¶åœ°æµ·é®®é¤å»³", note: "" }
                ]
            },
            {
                day: 4,
                date: "1/5 (é€±ä¸€)",
                base: "ä¼Šå‹¢/é³¥ç¾½ (I2)",
                title: "ä¼Šå‹¢æ–‡åŒ–ï¼šå¾¡è”­æ©«ä¸èˆ‡å¤«å©¦å²©",
                details: [
                    { time: "09:30", activity: "å¾¡è”­æ©«ä¸èˆ‡å„é™¤ç”º", transport: "æ­¥è¡Œ (è¿‘å…§å®®)", note: "è€è¡—æ•£æ­¥èˆ‡è³¼ç‰©ã€‚" },
                    { time: "11:30", activity: "åˆé¤", transport: "è€è¡—å…§", note: "å“åšä¼Šå‹¢çƒé¾éºµæˆ–èµ¤ç¦ã€‚" },
                    { time: "14:00", activity: "äºŒè¦‹æµ¦", transport: "CAN Bus", note: "è§€è³å¤«å©¦å²©ï¼Œæµ·é‚Šé¢¨å¤§ï¼Œæ³¨æ„ä¿æš–ã€‚" },
                    { time: "16:00", activity: "é³¥ç¾½åœ°å€è§€å…‰", transport: "CAN Bus", note: "é¸æ“‡é³¥ç¾½æ°´æ—é¤¨ï¼ˆå®¤å…§ï¼‰æˆ–å¾¡æœ¨æœ¬çç å³¶ã€‚" },
                    { time: "19:30", activity: "æ™šé¤", transport: "é£¯åº—æˆ–ç•¶åœ°é¤å»³", note: "å……è£•æ™‚é–“ä¼‘æ¯ã€‚" }
                ]
            },
            {
                day: 5,
                date: "1/6 (é€±äºŒ)",
                base: "ä¼Šå‹¢/é³¥ç¾½ (I3)",
                title: "æ¾é˜ªæ­·å²èˆ‡ç¾é£Ÿï¼šäº«ç”¨æ¾é˜ªç‰›",
                details: [
                    { time: "10:00", activity: "é³¥ç¾½/ä¼Šå‹¢å‘¨é‚Šè‡ªç”±æ´»å‹•", transport: "æ­¥è¡Œ", note: "æ‚ é–’æ—©æ™¨ï¼Œä¸è¶•æ™‚é–“ã€‚" },
                    { time: "12:30", activity: "åˆé¤", transport: "é£¯åº—é™„è¿‘", note: "" },
                    { time: "14:30", activity: "ä¼Šå‹¢ â†’ æ¾é˜ª", transport: "è¿‘éµæ€¥è¡Œåˆ—è»Š", note: "è»Šç¨‹ï¼šç´„ 45 åˆ†é˜ã€‚" },
                    { time: "15:30", activity: "æ¾é˜ªåŸè·¡å‘¨é‚Š", transport: "æ­¥è¡Œ", note: "åªåƒè§€å±±è…³ä¸‹çš„æ­¦å£«å±‹æ•·ç­‰å¹³é¢æ™¯é»ï¼Œé¿å…çˆ¬å¡ã€‚" },
                    { time: "19:00", activity: "æ™šé¤", transport: "æ¾é˜ªå¸‚å€", note: "äº«ç”¨è‘—åçš„æ¾é˜ªç‰›ã€‚" },
                    { time: "20:30", activity: "æ¾é˜ª â†’ é³¥ç¾½/ä¼Šå‹¢", transport: "è¿‘éµåˆ—è»Š", note: "è¿”å›é£¯åº—ä¼‘æ¯ã€‚" }
                ]
            },
            {
                day: 6,
                date: "1/7 (é€±ä¸‰)",
                base: "åå¤å±‹ (N3)",
                title: "ç§»å‹•æ—¥ï¼šå†¬å­£é»ç‡ˆåèŠ±ä¹‹é‡Œ",
                details: [
                    { time: "09:00", activity: "Check-out ä¼Šå‹¢/é³¥ç¾½é£¯åº—", transport: "è™•ç†è¡Œæ", note: "ä»Šæ—¥æ¬å®¶å›åå¤å±‹ï¼Œæ•´ç†è¡Œæã€‚" },
                    { time: "10:30", activity: "ä¼Šå‹¢ â†’ æ¡‘å", transport: "è¿‘éµç‰¹æ€¥åˆ—è»Š (éœ€è½‰è»Š)", note: "è»Šç¨‹ï¼šç´„ 1.5 å°æ™‚ã€‚" },
                    { time: "12:30", activity: "åˆé¤", transport: "æ¡‘åæˆ–é•·å³¶åœ°å€", note: "" },
                    { time: "14:30", activity: "å‰å¾€åèŠ±ä¹‹é‡Œ", transport: "å·´å£«/è¨ˆç¨‹è»Š", note: "" },
                    { time: "16:00", activity: "åèŠ±ä¹‹é‡Œ åœ’å€æ•£æ­¥", transport: "æ­¥è¡Œ", note: "åœ’å€è·¯é¢å¹³å¦ï¼Œé©åˆé•·è€…æ•£æ­¥ï¼Œç­‰å¾…é»ç‡ˆã€‚" },
                    { time: "18:00", activity: "åèŠ±ä¹‹é‡Œ å†¬å­£é»ç‡ˆ", transport: "è§€è³", note: "**å†¬å­£æˆ¶å¤–å¯’å†·ï¼Œå‹™å¿…å¤šç©¿ä¿æš–è¡£ç‰©**ã€‚" },
                    { time: "20:00", activity: "åèŠ±ä¹‹é‡Œ â†’ åå¤å±‹", transport: "ç›´é”å·´å£«æˆ–è¿‘éµ (å¾æ¡‘åç«™)", note: "è»Šç¨‹ï¼šç´„ 30ï½50 åˆ†é˜ã€‚" },
                    { time: "21:30", activity: "Check-in åå¤å±‹é£¯åº—", transport: "æ­¥è¡Œ/è¨ˆç¨‹è»Š", note: "å†æ¬¡å…¥ä½åå¤å±‹é£¯åº—ï¼Œé€£çºŒå…¥ä½ 2 æ™šã€‚" }
                ]
            },
            {
                day: 7,
                date: "1/8 (é€±å››)",
                base: "åå¤å±‹ (N4)",
                title: "åå¤å±‹ï¼šæ­·å²æ–‡åŒ–èˆ‡è³¼ç‰©ç·©è¡",
                details: [
                    { time: "10:00", activity: "åå¤å±‹åŸ", transport: "åœ°éµååŸç·š", note: "åƒè§€å»£é—Šçš„åŸå€å’Œåº­åœ’ã€‚" },
                    { time: "12:30", activity: "åˆé¤", transport: "åå¤å±‹è»Šç«™/æ¦®", note: "å“åšé°»é­šé£¯ã€‚" },
                    { time: "14:30", activity: "å¾·å·åœ’èˆ‡ç¾è¡“é¤¨", transport: "åœ°éµæ«»é€šç·š", note: "åƒè§€å„ªé›…çš„æ—¥å¼åº­åœ’ã€‚" },
                    { time: "17:30", activity: "è‡ªç”±æ´»å‹•/è³¼ç‰©", transport: "åå¤å±‹è»Šç«™å‘¨é‚Š", note: "åœ¨ç™¾è²¨å…¬å¸æˆ–åœ°ä¸‹è¡—æ¡è³¼ä¼´æ‰‹ç¦®ã€‚" },
                    { time: "19:30", activity: "æ™šé¤", transport: "åå¤å±‹å¸‚å€", note: "æ­¡é€æ™šå®´ã€‚" },
                    { time: "21:00", activity: "æ‰“åŒ…è¡Œæ", transport: "é£¯åº—", note: "æº–å‚™éš”æ—¥é›¢å¢ƒã€‚" }
                ]
            },
            {
                day: 8,
                date: "1/9 (é€±äº”)",
                base: "é›¢å¢ƒ",
                title: "å›ç¨‹ï¼šæ‚ é–’å‰å¾€æ©Ÿå ´",
                details: [
                    { time: "10:00", activity: "æ—©é¤/Check-out", transport: "é£¯åº—", note: "ç¢ºèªæ‰€æœ‰è¡Œæå’Œç‰©å“ã€‚" },
                    { time: "12:00", activity: "åˆé¤", transport: "åå¤å±‹å¸‚å€", note: "æœ€å¾Œä¸€æ¬¡æ—¥å¼åˆé¤ã€‚" },
                    { time: "17:00", activity: "å‰å¾€ä¸­éƒ¨åœ‹éš›æ©Ÿå ´ (NGO)", transport: "åéµç‰¹æ€¥åˆ—è»Šæˆ– Î¼-SKY åˆ—è»Š", note: "è»Šç¨‹ï¼šç´„ 30ï½40 åˆ†é˜ã€‚é ç•™å……è¶³æ™‚é–“è¾¦ç†ç™»æ©Ÿã€‚" },
                    { time: "18:00", activity: "æŠµé”æ©Ÿå ´", transport: "æ©Ÿå ´æ‰‹çºŒ", note: "è¾¦ç†ç™»æ©Ÿå’Œé€€ç¨…æ‰‹çºŒã€‚" },
                    { time: "21:05", activity: "UO681 ç­æ©Ÿ å¾åå¤å±‹ (NGO) å‡ºç™¼", transport: "é¦™æ¸¯å¿«é‹", note: "é è¨ˆèµ·é£›æ™‚é–“ã€‚" },
                    { time: "00:05 (+1)", activity: "æŠµé”é¦™æ¸¯", transport: "èˆªç­æŠµé”", note: "" }
                ]
            }
        ];


        // --- Gemini API Setup & Utility ---
        const apiKey = ""; 
        const model = "gemini-2.5-flash-preview-09-2025";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
        
        // --- UI Element Selectors ---
        const packingListBtn = document.getElementById('toggle-packing-list');
        const packingListContent = document.getElementById('packing-list-content');
        const packingListLoading = document.getElementById('packing-list-loading');
        const packingListResults = document.getElementById('packing-list-results');
        const phrasesBtn = document.getElementById('toggle-phrases');
        const phrasesContent = document.getElementById('phrases-content');
        const phrasesLoading = document.getElementById('phrases-loading');
        const phrasesResults = document.getElementById('phrases-results');
        const itineraryContainer = document.getElementById('itinerary-container');
        const itineraryLoading = document.getElementById('itinerary-loading');
        const saveBtn = document.getElementById('save-itinerary-btn');

        // State to track if content has been generated to avoid re-generating on every close/open
        let isPackingListGenerated = false;
        let isPhrasesGenerated = false;

        
        // --- FIREBASE INITIALIZATION AND AUTH ---
        async function initializeFirebase() {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await setPersistence(auth, browserLocalPersistence);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    isAuthReady = true;
                    if (user) {
                        userId = user.uid;
                        document.getElementById('auth-status').innerHTML = `
                            èº«ä»½ï¼šå·²ç™»å…¥ (ç”¨æˆ¶ ID: <span class="font-mono text-xs text-teal-600">${userId}</span>)
                        `;
                        saveBtn.classList.remove('hidden');
                        saveBtn.disabled = false;
                        loadItinerary();
                    } else {
                        userId = null;
                        document.getElementById('auth-status').innerHTML = 'èº«ä»½ï¼šåŒ¿åä½¿ç”¨è€…';
                        saveBtn.classList.add('hidden');
                        renderItinerary(defaultItinerary);
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                document.getElementById('auth-status').innerHTML = `<span class="text-red-500">Firebase é€£ç·šå¤±æ•—ï¼</span>`;
                isAuthReady = true;
                renderItinerary(defaultItinerary);
            }
        }

        // --- FIREBASE DATA FUNCTIONS ---
        
        function getItineraryDocRef() {
            if (!userId) {
                console.error("User not authenticated for Firestore operation.");
                return null;
            }
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            // Path: /artifacts/{appId}/users/{userId}/travel_plans/itinerary_doc
            return doc(db, 'artifacts', appId, 'users', userId, 'travel_plans', 'itinerary_doc');
        }

        // Save the current itinerary and packing list state
        async function saveItinerary() {
            const docRef = getItineraryDocRef();
            if (!docRef) return;
            
            saveBtn.disabled = true;
            saveBtn.textContent = 'å„²å­˜ä¸­...';

            try {
                await setDoc(docRef, {
                    itinerary: currentItinerary,
                    packingListStatus: packingListStatus, // Save the checked state
                    updatedAt: new Date().toISOString()
                }, { merge: true });

                console.log("Itinerary saved successfully!");
            } catch (error) {
                console.error("Error saving itinerary:", error);
                // Use custom modal or message box if needed, not alert()
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'ğŸ’¾ å„²å­˜è¡Œç¨‹è‡³é›²ç«¯';
            }
        }

        // Load itinerary and listen for real-time changes
        function loadItinerary() {
            const docRef = getItineraryDocRef();
            if (!docRef) return;

            itineraryLoading.classList.remove('hidden');

            onSnapshot(docRef, (docSnap) => {
                itineraryLoading.classList.add('hidden');
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    currentItinerary = data.itinerary || defaultItinerary;
                    packingListStatus = data.packingListStatus || [];
                    console.log("Itinerary loaded from Firestore.", data);
                } else {
                    // Initialize with default data if document doesn't exist
                    currentItinerary = defaultItinerary;
                    console.log("No itinerary found, initializing with default data.");
                    // Optionally save the default data immediately
                    // saveItinerary(); 
                }
                
                // Re-render both parts
                renderItinerary(currentItinerary);

                // If packing list was generated, re-render it with saved status
                if (isPackingListGenerated) {
                    renderPackingListUI(currentItinerary); // Packing list data is not stored in currentItinerary, so we only need to call render to apply saved status
                }
            }, (error) => {
                itineraryLoading.classList.add('hidden');
                console.error("Error listening to itinerary:", error);
                renderItinerary(defaultItinerary); // Fallback to default
            });
        }
        
        // Function to update packing list status (checked/unchecked)
        function updatePackingStatus(itemKey, isChecked) {
            if (isChecked) {
                // Add to the list of checked items
                if (!packingListStatus.includes(itemKey)) {
                    packingListStatus.push(itemKey);
                }
            } else {
                // Remove from the list of checked items
                packingListStatus = packingListStatus.filter(key => key !== itemKey);
            }
            
            // Auto-save the status to Firestore
            saveItinerary();
        }

        // --- UI Rendering Functions ---

        // Renders the main itinerary cards
        function renderItinerary(data) {
            itineraryContainer.innerHTML = ''; // Clear existing content
            
            data.forEach(dayData => {
                const card = document.createElement('div');
                card.className = 'itinerary-card bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-xl cursor-pointer border border-stone-100';

                // Header (Clickable Accordion Trigger) - Soft Teal background
                const header = document.createElement('div');
                header.className = 'flex justify-between items-center p-5 bg-teal-50 hover:bg-teal-100 transition-colors duration-200 border-b border-teal-200';
                header.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <div class="text-2xl font-bold text-teal-700">Day ${dayData.day}</div>
                        <div>
                            <p class="text-lg font-semibold text-stone-800">${dayData.title}</p>
                            <p class="text-sm text-stone-500 mt-0.5">${dayData.date} | ä½å®¿ï¼š${dayData.base}</p>
                        </div>
                    </div>
                    <svg class="arrow w-6 h-6 text-teal-600 transition-transform duration-300 transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                `;
                
                // Content (Hidden Details)
                const content = document.createElement('div');
                content.className = 'itinerary-accordion-content';
                
                const table = document.createElement('div');
                table.className = 'space-y-3';
                
                dayData.details.forEach(detail => {
                    const row = document.createElement('div');
                    // Cleaner row structure
                    row.className = 'grid grid-cols-1 md:grid-cols-8 gap-2 md:gap-4 py-3 px-1 border-b border-stone-100 last:border-b-0 transition-colors duration-150 hover:bg-stone-50 rounded-lg';
                    
                    row.innerHTML = `
                        <!-- Time: Muted, clear -->
                        <div class="font-semibold text-sm text-stone-500 col-span-1 md:col-span-1">${detail.time}</div>
                        <!-- Activity: Main text -->
                        <div class="col-span-1 md:col-span-3 text-stone-700 font-medium">${detail.activity}</div>
                        <!-- Transport: Secondary info, lighter color -->
                        <div class="col-span-1 md:col-span-2 text-teal-500 text-xs italic">${detail.transport}</div>
                        <!-- Note: Important caution in a warmer, emphasis color -->
                        <div class="col-span-1 md:col-span-2 text-pink-600 text-xs font-light">${detail.note}</div>
                    `;
                    table.appendChild(row);
                });

                content.appendChild(table);
                card.appendChild(header);
                card.appendChild(content);
                itineraryContainer.appendChild(card);

                // Accordion Logic
                header.addEventListener('click', () => {
                    // Toggle visibility of content
                    const isActive = content.classList.toggle('active');
                    
                    // Toggle arrow rotation
                    const arrow = header.querySelector('.arrow');
                    if (isActive) {
                        arrow.classList.add('rotate-180');
                    } else {
                        arrow.classList.remove('rotate-180');
                    }
                });
            });
        }


        // Renders the packing list with the saved checked status
        function renderPackingListUI(packingList) {
            let html = '<div class="space-y-4">';
            
            packingList.forEach((cat, catIndex) => {
                html += `<div class="p-4 bg-white rounded-xl border border-lime-200 shadow-sm">
                            <h3 class="text-lg font-bold text-teal-600 border-b border-lime-300 pb-1 mb-3">${cat.category}</h3>
                            <div class="space-y-2">`;
                cat.items.forEach((item, itemIndex) => {
                    // Unique key for Firestore state tracking
                    const itemKey = `${catIndex}-${itemIndex}`; 
                    const isChecked = packingListStatus.includes(itemKey);
                    const labelClass = isChecked ? 'checked-item' : '';

                    html += `
                        <div class="flex items-start">
                            <input type="checkbox" id="item-${itemKey}" data-key="${itemKey}" ${isChecked ? 'checked' : ''} class="mt-1 h-4 w-4 text-lime-600 border-stone-300 rounded focus:ring-lime-500 packing-checkbox">
                            <label for="item-${itemKey}" class="ml-3 text-sm font-medium text-stone-700 select-none cursor-pointer hover:text-lime-600 transition leading-relaxed ${labelClass}">${item}</label>
                        </div>
                    `;
                });
                html += `</div></div>`;
            });
            html += '</div>';

            packingListResults.innerHTML = html;

            // Add event listeners to the new checkboxes
            document.querySelectorAll('.packing-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (event) => {
                    const key = event.target.getAttribute('data-key');
                    const isChecked = event.target.checked;
                    
                    // Toggle the visual class on the label
                    const label = document.querySelector(`label[for="item-${key}"]`);
                    if (label) {
                        label.classList.toggle('checked-item', isChecked);
                    }
                    
                    updatePackingStatus(key, isChecked);
                });
            });
        }


        // --- Gemini API Functions (same as before, but calling renderPackingListUI) ---

        // Utility function for exponential backoff
        async function fetchWithRetry(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status !== 429) { // Not a rate limit error
                        return response;
                    }
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        
        function showLoading(loadingElement, resultsElement) {
            loadingElement.classList.remove('hidden');
            resultsElement.classList.add('hidden');
            resultsElement.innerHTML = '';
        }

        function hideLoading(loadingElement, resultsElement) {
            loadingElement.classList.add('hidden');
            resultsElement.classList.remove('hidden');
        }

        /**
         * Generic function to toggle the accordion (expand/collapse)
         */
        async function toggleAccordion(btn, content, loading, generator, isGenerated, setGenerated) {
            const isActive = content.classList.toggle('active');
            const arrow = btn.querySelector('svg');
            
            if (isActive) {
                arrow.classList.add('rotate-180');
                if (!isGenerated) {
                    await generator(content, loading, setGenerated);
                }
            } else {
                arrow.classList.remove('rotate-180');
            }
        }

        // --- Feature 1: Packing List Generator ---
        async function generatePackingList(contentElement, loadingElement, setGenerated) {
            showLoading(loadingElement, packingListResults);

            const systemInstruction = {
                parts: [{ text: "ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„æ—…éŠè¦åŠƒåŠ©ç†ã€‚è«‹æ ¹æ“šä»¥ä¸‹æ—…è¡Œç´°ç¯€ï¼Œç”Ÿæˆä¸€ä»½è©³ç´°çš„è¡Œææ¸…å–®ã€‚ç”±æ–¼æ˜¯å†¬å­£ï¼ˆ1æœˆï¼‰å‰å¾€ç™½å·é„‰ã€åå¤å±‹å’Œä¼Šå‹¢ï¼Œä¸”æœ‰é•·è€…åŒè¡Œï¼Œè«‹å¼·èª¿ä¿æš–ã€é˜²æ»‘å’Œé•·è€…è­·ç†ç”¨å“ã€‚è«‹ä»¥çµæ§‹åŒ–çš„ JSON æ ¼å¼å›æ‡‰ï¼ŒåŒ…å«æ•¸å€‹åˆ†é¡ã€‚" }]
            };
            
            const userQuery = "8å¤©7å¤œï¼Œæ—¥æœ¬åå¤å±‹ã€ä¸‰é‡ç¸£ã€ç™½å·é„‰ã€‚æ™‚é–“ï¼š1æœˆï¼ˆå†¬å­£ï¼‰ï¼Œæœ‰é•·è€…åŒè¡Œï¼Œéœ€è€ƒæ…®ä¿æš–å’Œé•·é€”ç§»å‹•èˆ’é©åº¦ã€‚è«‹ç”Ÿæˆä¸€ä»½å¯¦ç”¨çš„è¡Œææ¸…å–®ã€‚";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: systemInstruction,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "category": { "type": "STRING", description: "ä¾‹å¦‚: è¡£ç‰© (ä¿æš–), è—¥å“èˆ‡è­·ç†, æ—…éŠå¿…éœ€å“" },
                                "items": {
                                    "type": "ARRAY",
                                    "items": { "type": "STRING" },
                                    description: "è©²åˆ†é¡ä¸‹çš„å»ºè­°æ¸…å–®é …ç›®"
                                }
                            },
                            "propertyOrdering": ["category", "items"]
                        }
                    }
                }
            };

            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!jsonText) throw new Error("API response is empty or malformed.");

                const packingList = JSON.parse(jsonText);
                
                // --- RENDER & SAVE LOGIC HERE ---
                renderPackingListUI(packingList);
                setGenerated(true);

            } catch (error) {
                packingListResults.innerHTML = `<p class="text-red-500 p-4">ç”Ÿæˆæ¸…å–®æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚ (${error.message})</p>`;
            } finally {
                hideLoading(loadingElement, packingListResults);
            }
        }

        // --- Feature 2: Emergency Phrase Generator ---
        async function generatePhrases(contentElement, loadingElement, setGenerated) {
            showLoading(loadingElement, phrasesResults);

            const systemInstruction = {
                parts: [{ text: "ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„æ—¥æœ¬æ—…éŠå£è­¯å“¡ã€‚è«‹ç”Ÿæˆ 5 å€‹åœ¨æ—…è¡Œä¸­ï¼ˆç‰¹åˆ¥æ˜¯æœ‰é•·è€…åŒè¡Œæ™‚ï¼‰æœ€å¯¦ç”¨ä¸”æ€¥éœ€çš„æ—¥èªæ±‚åŠ©çŸ­èªã€‚å›æ‡‰éœ€ä½¿ç”¨ JSON æ ¼å¼ï¼ŒåŒ…å«: ç¹é«”ä¸­æ–‡, æ—¥èªç™¼éŸ³ (ç¾…é¦¬æ‹¼éŸ³), æ—¥èªåŸæ–‡ã€‚" }]
            };

            const userQuery = "è«‹ç”Ÿæˆ 5 å€‹é—œæ–¼å”åŠ©é•·è€…ã€é†«ç™‚æ±‚åŠ©æˆ–å°‹æ‰¾è¨­æ–½çš„å¯¦ç”¨æ—¥èªçŸ­èªã€‚";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: systemInstruction,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "chinese": { "type": "STRING" },
                                "romaji": { "type": "STRING" },
                                "japanese": { "type": "STRING" }
                            },
                            "propertyOrdering": ["chinese", "romaji", "japanese"]
                        }
                    }
                }
            };

            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!jsonText) throw new Error("API response is empty or malformed.");

                const phrases = JSON.parse(jsonText);
                let html = '';

                phrases.forEach((p, index) => {
                    html += `
                        <div class="p-4 bg-white rounded-xl border border-pink-200 transition-shadow duration-300 hover:shadow-md">
                            <p class="text-sm font-bold text-pink-600">${index + 1}. ${p.chinese}</p>
                            <p class="text-xl font-mono mt-1 text-stone-800">${p.japanese}</p>
                            <p class="text-xs text-stone-400 italic mt-1">(${p.romaji})</p>
                        </div>
                    `;
                });
                
                phrasesResults.innerHTML = html;
                setGenerated(true);

            } catch (error) {
                phrasesResults.innerHTML = `<p class="text-red-500 p-4">ç”Ÿæˆç”¨èªæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚ (${error.message})</p>`;
            } finally {
                hideLoading(loadingElement, phrasesResults);
            }
        }

        // --- Event Listeners and Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Attach Gemini feature event listeners
            packingListBtn.addEventListener('click', () => {
                toggleAccordion(
                    packingListBtn, 
                    packingListContent, 
                    packingListLoading, 
                    generatePackingList, 
                    isPackingListGenerated,
                    (status) => isPackingListGenerated = status
                );
            });
            
            phrasesBtn.addEventListener('click', () => {
                toggleAccordion(
                    phrasesBtn, 
                    phrasesContent, 
                    phrasesLoading, 
                    generatePhrases, 
                    isPhrasesGenerated,
                    (status) => isPhrasesGenerated = status
                );
            });

            // Save button listener
            saveBtn.addEventListener('click', saveItinerary);
            
            // Initialize Firebase and load data
            initializeFirebase();
        });
    </script>
</body>
</html>
